@using EventManager1.Models
@{
    /**/

    ViewBag.Title = "Status";
    Layout = "~/Views/Shared/_Layout.cshtml";
    <style>
        .btn-lg {
            padding: 1.5rem 1.7rem !important;
            font-size: 1.25rem !important;
            line-height: 0.5 !important;
        }
        .paystatus {
            font-size: inherit;
        }
        .card-body{padding:0 !important}
        .Paycheck {
            color: red !important;
            text-decoration: underline;
            font-weight: 800;
        }

        .btn-status {
            background: #21ab64;
            padding: 10px 20px;
            color: aliceblue !important;
            width: 100%;
        }

        .smal-btn {
            background: #f48534;
            color: #fff;
            border: none;
        }

        .mt-5, .my-5 {
            margin-top: 7rem !important;
        }

        .mb-3.text-center {
            padding-top: 2%;
        }

        h4 {
            font-size: 2.5rem;
        }
/*
        .btn-lg {
            padding: 1.5rem 2rem;
        }*/

        .fas {
            font-size: 16px;
        }

        a.btn.btn-success {
            color: #fff;
        }

        a.btn.btn-primary {
            color: #fff;
        }

        a.btn.btn-info {
            color: #fff;
        }

        a.btn.btn-warning {
            color: #333;
        }

        .lds-spinner {
            color: official;
            display: inline-block;
            position: relative;
            width: 64px;
            height: 64px;
        }

            .lds-spinner div {
                transform-origin: 32px 32px;
                animation: lds-spinner 1.2s linear infinite;
            }

                .lds-spinner div:after {
                    content: " ";
                    display: block;
                    position: absolute;
                    top: 3px;
                    left: 29px;
                    width: 5px;
                    height: 14px;
                    border-radius: 20%;
                    background: #21ab64;
                }

                .lds-spinner div:nth-child(1) {
                    transform: rotate(0deg);
                    animation-delay: -1.1s;
                }

                .lds-spinner div:nth-child(2) {
                    transform: rotate(30deg);
                    animation-delay: -1s;
                }

                .lds-spinner div:nth-child(3) {
                    transform: rotate(60deg);
                    animation-delay: -0.9s;
                }

                .lds-spinner div:nth-child(4) {
                    transform: rotate(90deg);
                    animation-delay: -0.8s;
                }

                .lds-spinner div:nth-child(5) {
                    transform: rotate(120deg);
                    animation-delay: -0.7s;
                }

                .lds-spinner div:nth-child(6) {
                    transform: rotate(150deg);
                    animation-delay: -0.6s;
                }

                .lds-spinner div:nth-child(7) {
                    transform: rotate(180deg);
                    animation-delay: -0.5s;
                }

                .lds-spinner div:nth-child(8) {
                    transform: rotate(210deg);
                    animation-delay: -0.4s;
                }

                .lds-spinner div:nth-child(9) {
                    transform: rotate(240deg);
                    animation-delay: -0.3s;
                }

                .lds-spinner div:nth-child(10) {
                    transform: rotate(270deg);
                    animation-delay: -0.2s;
                }

                .lds-spinner div:nth-child(11) {
                    transform: rotate(300deg);
                    animation-delay: -0.1s;
                }

                .lds-spinner div:nth-child(12) {
                    transform: rotate(330deg);
                    animation-delay: 0s;
                }

        @@keyframes lds-spinner {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .card {
            border: 0;
            margin: 0 0px;
            padding: 0px 0 0px 0;
            min-height: auto !important;
        }

        .message {
            background: #e8dc82;
            padding: 10px 20px;
            border: 1px solid #bbab33;
            border-radius: 10px;
            text-align: center;
        }

            .message ul {
                margin: 0px;
            }

                .message ul li {
                    color: #343a40;
                }
    </style>
}
@if (ViewData["paytype"] != null && ViewData["paytype"].ToString() == "1")
{
    PaymentStatuss pay = new PaymentStatuss();
    if (ViewData["Paymodel"] != null)
    {
        pay = ViewData["Paymodel"] as PaymentStatuss;
        <div class="container-fluid bgContainer" id="paystatus">
            <div class="row">
                <div class="container">
                    <div class="row  mt-5 mb-5" style="margin-bottom:5rem !important;">
                        <div class="col-md-12 my-auto">
                            <div class="card d-flex" style="padding:30px 0">
                                <div class="row" style="margin:0 auto">
                                    <div class="col-md-12">
                                        <div class="message">
                                            @if (pay.status == "SUCCESSFUL")
                                            {
                                                <p id="Success">Thanks for your Payment. Your Payment of Gh₵@pay.total has been received.</p> }
                                            else
                                            {
                                                <p id="fail">Your Payment of Gh₵@pay.total is Failed. Please try again.</p>}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3 text-center">
                                        @if (pay.status == "SUCCESSFUL")
                                        {
                                            <div id="divSuccess">
                                                <div>
                                                    <button class="btn btn-success text-white borderR50 btn-lg">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </div><br />
                                                <h4 class="pt-2"> Payment Status : Success </h4>
                                                <h5>Transaction Id : @pay.TransId </h5>
                                                <h4>Total Amount : Gh₵@pay.total</h4>
                                                <p class="text-muted">
                                                    @pay.message
                                                </p>
                                                @if (ManageSession.TicketCartSession != null && ManageSession.TicketCartSession.Eventtype == 1)
                                                {
                                                    <a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-primary smal-btn">Go to Your Event</a> @*<span>|</span> <a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-outline-secondary"> Watch Movie </a>*@
                                                }
                                                else if (ManageSession.TicketCartSession != null && ManageSession.TicketCartSession.Eventtype == 2)
                                                {
                                                    <a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-primary">Go to Your Event</a> @*<span>|</span> <a href="@Url.Action("LiveEvents", "Events", new { area = "User" })" class="btn btn-outline-secondary"> Watch Live Event </a>}*@
                                                }
                                                else
                                                {
                                                    <a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-primary">Go to Your Event</a>
                                                    //<a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-primary">Download</a> <span>|</span> <a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-outline-secondary"> View Ticket </a> <span>|</span>
                                                    //<a href="@Url.Action("Dashboard", "User", new { area = "User" })" class="btn btn-outline-secondary">Dashboard</a> <span>|</span>

                                                }
                                                <a href="/" class="btn btn-outline-secondary">  Browse  Events </a>
                                            </div>
                                        }
                                        else
                                        {
                                            <div id="divFail">
                                                <div>
                                                    <button class="btn btn-danger text-white borderR50 btn-lg" style="padding: 1.5rem 1.7rem !important;">
                                                        <i class="fa fa-times" aria-hidden="true"></i>
                                                    </button>
                                                </div><br />
                                                <h5>Transaction Id : @pay.TransId </h5>
                                                <h4>Total Amount : Gh₵@pay.total</h4>
                                                <h5 class="text-muted paystatus">
                                                    <b>Payment Status</b>   : <span style="color:red !important;">@ViewBag.msg</span> <br />
                                                    If your account has been debited, Please <a href="javascript:" class="Paycheck" onclick="LoadTicket('@ViewBag.paymentid', '@pay.TransId', '@ViewBag.paymentfor','@ViewBag.gateway')">click here</a> and we will attempt to issue your event pass again. Kindly note this will not initiate another payment authorization request from you .
                                                </h5>

                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    }
}

else if (ViewData["paytype"] != null && ViewData["paytype"].ToString() == "0")
{
    <div class="container-fluid bgContainer" id="paywaiting">
        <div class="row">
            <div class="container">
                <div class="row  mt-5 mb-5" style="margin-bottom:5rem !important;">
                    <div class="col-md-12 my-auto">
                        <div class="card d-flex" style="padding:30px 0">
                            <div class="card-body">

                                <div class="mb-3 ">

                                    <div style="margin-bottom:30px; text-align:center ">
                                        <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                    </div>
                                    <h4 class="pt-2">
                                        <div class="message">
                                            Your payment is pending for approval. You have to approve  the payment from your mobile money.
                                        </div>
                                    </h4>
                                    <h5>Here's how to approve a payment request:</h5>
                                    <ul>
                                        <li>
                                            Dial *170# and select Option 10, My Wallet.
                                        </li>
                                        <li>Select Option 2 for My Approvals.</li>
                                        <li>Enter PIN to get your Pending Approval List.</li>
                                        <li>Select pending transaction to approve.</li>
                                        <li>Select Option 1 YES to approve the transaction OR Option 2 NO to reject the transaction</li>

                                    </ul>
                                    <p>Customer receives an SMS as confirmation for a successful transaction.</p>
                                    <p>All services which require debits on a customer's wallet will have to go through the approval process before it can be completed.</p>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
}
<div class="container-fluid bgContainer" id="paystatus" style="display:none">
    <div class="row">
        <div class="container">
            <div class="row  mt-5 mb-5" style="margin-bottom:5rem !important;">
                <div class="col-md-12 my-auto">
                    <div class="card d-flex" style="padding:30px 0">
                        <div class="row" style="margin:0 auto">
                            <div class="col-md-12">
                                <div class="message">
                                    <p id="pending" style="display:none">Thanks for your Payment. Your Payment status of Gh₵@ViewData["total"] is Pending .<br /> Please check after sometime.</p>
                                    <p id="Success" style="display:none">Thanks for your Payment. Your Payment of Gh₵@ViewData["total"] has been received.</p>
                                    <p id="SuccessFree" style="display:none; font-size:small">Congratulations!  Ticket booked successfully.</p>
                                    <p id="failFree" style="display:none">Oops! Something went wrong.</p>
                                    <p id="fail" style="display:none">Your Payment of Gh₵@ViewData["total"] is Failed. Please try again.</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3 text-center">
                                <div id="divSuccess" style="display:none">
                                    <div>
                                        <button class="btn btn-success text-white borderR50 btn-lg">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <h4 class="pt-2"> Payment Status : Success </h4>
                                    <div id="succesFree">
                                        <h5>
                                            Transaction Id : <label id="transaction"></label> @if (ViewBag.trxId != null)
                                            {@ViewBag.trxId}
                                        </h5>

                                        <h5>Total Amount : Gh₵<label id="total"></label> @ViewData["total"]</h5>

                                        <p class="text-muted">
                                            <label id="messagesuccess"></label>
                                        </p>
                                    </div><br />
                                    <div id="pevent">
                                        <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-primary">Go to Your Event</a>
                                        @*<a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-primary">Download</a> <span>|</span> <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-outline-secondary"> View Ticket </a> <span>|</span>
                                            <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-outline-secondary">Dashboard</a> <span>|</span> <a href="/" class="btn btn-outline-secondary">  Browse  Events </a>}*@
                                    </div>  <div style="display:none" id="revent">
                                        <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-primary smal-btn">Go to Your Event</a> @*<span>|</span> <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-outline-secondary"> Watch Movie </a> <span>|</span> <a href="/" class="btn btn-outline-secondary">  Browse  Events </a>*@
                                    </div>
                                    <div style="display:none" id="Liveevent">
                                        <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-primary smal-btn">Go to Your Event</a>@* <span>|</span> <a href="@Url.Action("LiveEvents","Events",new {area="User" })" class="btn btn-outline-secondary"> Watch Live Streaming </a> <span>|</span> <a href="/" class="btn btn-outline-secondary">  Browse  Events </a>*@
                                    </div>
                                </div>
                                <div id="divPendings" style="display:none">
                                    <div>
                                        <div>
                                            <button class="btn btn-success text-white borderR50 btn-lg">
                                                <i class="fas fa-exclamation-circle"></i>
                                            </button>
                                        </div>

                                    </div><br />
                                    <h4 class="pt-2"> Payment Status : Pending </h4>
                                    <h5>Transaction Id : <label id="transactionp"></label> </h5>
                                    <h5>Total Amount : Gh₵<label id="totalp"></label></h5>
                                    <p class="text-muted">
                                        <label id="messagePending">
                                            Your payment is pending for approval from telco. Once it is confirmed, we will send you ticket on your email.
                                        </label>
                                    </p>
                                    <a href="@Url.Action("Dashboard","User",new {area="User" })" class="btn btn-outline-secondary" style="text-align:center"> View Ticket </a>
                                </div>
                                <div id="divPending" style="display:none">
                                    <div>
                                        <div style="margin-bottom:30px; text-align:center ">
                                            <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                        </div>
                                        <h4 class="pt-2">
                                            <div class="message">
                                                Your payment is pending for approval. You have to approve  the payment from your mobile money.
                                            </div>
                                        </h4>
                                    </div><br />

                                </div>

                                <div id="divFail" style="display:none">
                                    <div>
                                        <button class="btn btn-danger text-white borderR50 btn-lg" style="padding: 1.5rem 1.7rem !important;">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </button>
                                    </div><br />
                                    <h4 class="pt-2" id="msgfails" style="display:none"> Payment Failed! </h4>
                                    <div id="divfailfree">
                                        <h4 class="pt-2"> Transaction Failed </h4>
                                        <h5>
                                            Transaction Id : <label id="transactionf"></label> @if (ViewBag.trxId != null)
                                            {@ViewBag.trxId}
                                        </h5>
                                        <h5>Total Amount : Gh₵<label id="totalf"></label> @ViewData["total"]</h5>
                                        @*<p class="text-muted">
                                                <label id="messageFailed" style="color:red"></label>
                                                @if (ViewBag.msg != null)
                                                {<label id="messageFailed" style="color:red">@ViewBag.msg</label>}
                                            </p>*@

                                        <h5 class="text-muted paystatus">
                                            <b>Payment Status</b>   : <span style="color:red !important;">@ViewBag.msg</span> <br />
                                            If your account has been debited, Please <a href="javascript:" class="Paycheck"  onclick="LoadTicket('@ViewBag.paymentid', '@ViewBag.trxId', '@ViewBag.paymentfor','@ViewBag.gateway')">click here</a> and we will attempt to issue your event pass again. Kindly note this will not initiate another payment authorization request from you .
                                        </h5>
                                        <h4 id="tryagan">
                                            <a href="@Url.Action("FailedPayment","Transaction",new {area="User" })" class="btn-status">Check Status</a>
                                            <a href="@Url.Action("Index","Home",new {area="" })" class="btn-default" style="color:aliceblue!important">Try Again</a>
                                        </h4>
                                    </div>
                                    @*<p class="text-muted" style="text-align:left">
                                            The transaction has failed due to one of the following reasons:
                                            <ul>
                                                <li>
                                                    Your phone was unreachable due to lack of signal or temporary problems with your mobile phone network.
                                                </li>
                                                <li>
                                                    Your mobile phone network has put a premium messaging or carrier billing block on your mobile number.
                                                </li>
                                                <li>
                                                    Your pre-paid/pay as you go phone is low on credits.  Some mobile phone companies require a minimum amount of funds additional to the amount you request for the transaction to complete.
                                                </li>
                                            </ul>
                                        </p>*@
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
}

<div id="divticketcontent">

</div>
<button type="button" style="display:none" id="btnticketpopup" data-toggle="modal" data-target="#tickets" class="card-link flex-fill bd-highlight">Tickets</button>



@*<script type="text/javascript">
        $(document).ready(function () {

        });
    </script>*@
@section Scripts
{
    <script>
        //function preventBack() { window.history.forward(); }
        //setTimeout("preventBack()", 0);
        //window.onunload = function () { null };

        var num =0 ;
        $(document).ready(function () {
            debugger;
            function disablePrev() { window.history.forward() }
            window.onload = disablePrev();
            window.onpageshow = function (evt) { if (evt.persisted) disableBack() }

            var status = '@ViewData["Status"]';
            var paymode = '@ViewData["paytype"]';
            var trxId = '@ViewBag.trxId';
            var trxId = '@ViewBag.msg';
            if (paymode == '0') {
                if (status != '') {
                    if (status == 'SUCCESSFUL') {
                        $('#succesFree').css("display", "none");
                        if (trxId != null) { $('#succesFree').css("display", "block");}
                        $('#SuccessFree').css("display", "block");
                        $('#paystatus').css("display", "block");
                        $('#divFail').css("display", "none");
                        $('#divSuccess').css("display", "block");
                        $('#fail').css("display", "none");
                        $('#paywaiting').css("display", "none");
                        var etype = '@ManageSession.TicketCartSession.Eventtype';
                        if(etype=='1')
                        {

                            $('#revent').css("display", "block");
                            $('#pevent').css("display", "none");
                            $('#Liveevent').css("display", "none");
                        }
                        else if (etype == '2') {

                            $('#revent').css("display", "none");
                            $('#pevent').css("display", "none");
                            $('#Liveevent').css("display", "block");
                        }
                        else {
                            $('#revent').css("display", "none");
                            $('#pevent').css("display", "block"); $('#Liveevent').css("display", "none");
                        }
                    }
                    else {
                        $('#paystatus').css("display", "block");
                        $('#divFail').css("display", "block");
                        //$('#fail').css("display", "block");
                        $('#failFree').css("display", "block");
                        $('#msgfails').css("display", "block");
                        $('#divfailfree').css("display", "none");
                        if (trxId != null) { $('#msgfails').css("display", "none");  $('#divfailfree').css("display", "block"); }
                        $('#paywaiting').css("display", "none");
                    }
                }
                else {
                    $('#paystatus').css("display", "none");
                    $('#paywaiting').css("display", "block");
                    setTimeout(function () { checkStatus(); }, 5000);
                }
            }
        });
        function checkStatus()
        {
            $.ajax({
                url: '@Url.Action("CheckPayStatus", "Payment")',
                type: "POST",
                contentType: false, // Not to set any content header
                processData: false, // Not to process data
                data: {},
                        success: function (result) {
                            debugger;
                            if (result != null) {
                                if (result.status == "PENDING") {
                                    debugger;
                                    if (num == 1) {
                                        $('#divPending').css("display", "none");
                                        $('#pending').css("display", "block");
                                        $('#divPendings').css("display", "block");
                                        $('#Success').css("display", "none");
                                        $('#fail').css("display", "none");
                                        $('#divFail').css("display", "none");
                                        $('#divSuccess').css("display", "none");
                                        pageRedirect();
                                        }
                                        else {
                                        checkStatus();
                                        num = num + 1;
                                        $('#divPending').css("display", "block"); $('#pending').css("display", "block");
                                            $('#Success').css("display", "none"); $('#fail').css("display", "none");
                                            $('#divFail').css("display", "none"); $('#divSuccess').css("display", "none"); $('#divPending').css("display", "block");
                                            $('#totalp').text(result.total);
                                            $('#transactionp').text(result.TransId);
                                        }

                                    //$('#messagePending').text(result.message); $('#totalp').text(result.total); $('#transactionp').text(result.TransId);
                                }
                                else if (result.status == "SUCCESSFUL") {

                                    $('#Success').css("display", "block"); $('#pending').css("display", "none"); $('#fail').css("display", "none");
                                    $('#divFail').css("display", "none"); $('#divSuccess').css("display", "block"); $('#divPending').css("display", "none");
                                    $('#messagesuccess').text(result.message); $('#total').text(result.total); $('#transaction').text(result.TransId);
                                }
                                else {
                                    $('#fail').css("display", "block"); $('#pending').css("display", "none"); $('#Success').css("display", "none");
                                    $('#divFail').css("display", "block"); $('#divSuccess').css("display", "none"); $('#divPending').css("display", "none");
                                    $('#messageFailed').text(result.message); $('#totalf').text(result.total); $('#transactionf').text(result.TransId);
                                }
                                $('#paystatus').css("display", "block");
                                $('#paywaiting').css("display", "none");
                            };
                        },
                        error: function (err) {
                            alert(err.statusText);
                        }
                });
        }
        function pageRedirect() {
            window.location.replace("@Url.Action("Dashboard", "User", new { area = "User" })");
        }
        $('#btn_Close').click(function () {
            window.location.href='@Url.Action("Dashboard", "User", new { area = "User" })';
        });
        function LoadTicket(Id, paymId, pfor, gateway) {
            debugger;
            $.ajax({
                url: '/User/Transaction/ChecktrxStatus?PaymentId=' + Id + '&TrxNo=' + paymId + '&paymentfor=' + pfor + '&PayGateway=' + gateway,
                contentType: 'application/html; charset=utf-8',
                type: 'GET',
                dataType: 'html',
                success: function (result) {
                    $('#divticketcontent').html(result);
                    $("#btnticketpopup").trigger("click");
                    //$('#tickets').modal('show');
                },
                error: function (xhr, status) {
                    alert(status);
                }
            })
            /**/
        }


    </script>
}

